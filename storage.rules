rules_version = '2';

// Firebase Storage Security Rules for HobbiesSpot.com
// Last Updated: 2025-10-26
// 
// Storage Structure:
// - /products/{productId}/... - Product images (sellers & admin)
// - /sellers/{sellerId}/... - Seller store assets
// - /users/{userId}/... - User profile assets
// - /auctions/{auctionId}/... - Auction images (sellers)
// - /orders/{orderId}/... - Order documents (private)
// - /returns/{returnId}/... - Return/refund documents (private)
// - /categories/{categoryId}/... - Category images (admin only)
// - /banners/... - Homepage/promotional banners (admin only)
// - /temp/{userId}/... - Temporary uploads (auto-cleanup)

service firebase.storage {
  match /b/{bucket}/o {
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.role == 'admin';
    }
    
    // Check if user is seller
    function isSeller() {
      return isAuthenticated() && 
             request.auth.token.role == 'seller';
    }
    
    // Check if user is the owner of the resource
    function isOwner(userId) {
      return isAuthenticated() && 
             request.auth.uid == userId;
    }
    
    // Validate image file types
    function isValidImage() {
      return request.resource.contentType.matches('image/.*') &&
             request.resource.contentType in [
               'image/jpeg', 
               'image/jpg',
               'image/png', 
               'image/webp', 
               'image/gif',
               'image/svg+xml'
             ];
    }
    
    // Validate document file types
    function isValidDocument() {
      return request.resource.contentType in [
        'image/jpeg', 
        'image/jpg',
        'image/png', 
        'image/webp',
        'application/pdf',
        'application/msword',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/vnd.ms-excel',
        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
      ];
    }
    
    // Check file size limit
    function isWithinSizeLimit(maxSizeMB) {
      return request.resource.size < maxSizeMB * 1024 * 1024;
    }
    
    // ==================== PRODUCT IMAGES ====================
    // Products: /products/{productId}/{imageId}
    // Read: Public
    // Write: Sellers (their own products) & Admins
    
    match /products/{productId}/{imageId} {
      allow read: if true; // Public product images
      
      // Allow sellers to upload/update/delete their own product images, admins can do everything
      allow create, update: if isAdmin() ||
                               (isSeller() &&
                                isValidImage() &&
                                isWithinSizeLimit(10)); // 10MB limit
      
      allow delete: if isAdmin() || isSeller();
    }
    
    // ==================== SELLER STORE ASSETS ====================
    // Sellers: /sellers/{sellerId}/store/{assetType}/{fileName}
    // Sellers: /sellers/{sellerId}/products/buy-{slug}/{fileName}
    // Assets include: logo, banner, certificates, product images, videos
    
    match /sellers/{sellerId}/shop/{fileName} {
      allow read: if true; // Public shop assets (logo, cover)
      
      allow create, update: if isAdmin() ||
                               (isOwner(sellerId) &&
                                isValidImage() &&
                                isWithinSizeLimit(5)); // 5MB limit
      
      allow delete: if isAdmin() || isOwner(sellerId);
    }
    
    match /sellers/{sellerId}/products/{productSlug}/{fileName} {
      allow read: if true; // Public product images
      
      allow create, update: if isAdmin() ||
                               (isOwner(sellerId) &&
                                isWithinSizeLimit(20)); // 20MB for videos
      
      allow delete: if isAdmin() || isOwner(sellerId);
    }
    
    match /sellers/{sellerId}/store/{assetType}/{fileName} {
      allow read: if true; // Public store assets
      
      allow create, update: if (isOwner(sellerId) || isAdmin()) &&
                               isValidImage() &&
                               isWithinSizeLimit(5); // 5MB limit
      
      allow delete: if isOwner(sellerId) || isAdmin();
    }
    
    // Seller verification documents (private)
    match /sellers/{sellerId}/verification/{documentId} {
      allow read: if isOwner(sellerId) || isAdmin();
      
      allow create, update: if isOwner(sellerId) &&
                               isValidDocument() &&
                               isWithinSizeLimit(10); // 10MB for verification docs
      
      allow delete: if isAdmin(); // Only admins can delete verification docs
    }
    
    // ==================== USER PROFILE ASSETS ====================
    // Users: /users/{userId}/profile/{fileName}
    // Avatars: /avatars/{userId}.{ext}
    
    match /avatars/{fileName} {
      allow read: if true; // Public profile images
      
      allow create, update: if isAdmin() ||
                               (isAuthenticated() &&
                                isValidImage() &&
                                isWithinSizeLimit(5)); // 5MB limit
      
      allow delete: if isAdmin() || isAuthenticated();
    }
    
    match /users/{userId}/profile/{fileName} {
      allow read: if true; // Public profile images
      
      allow create, update: if (isOwner(userId) || isAdmin()) &&
                               isValidImage() &&
                               isWithinSizeLimit(5); // 5MB limit
      
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // User documents (private - KYC, ID proof, etc.)
    match /users/{userId}/documents/{documentId} {
      allow read: if isOwner(userId) || isAdmin();
      
      allow create, update: if isOwner(userId) &&
                               isValidDocument() &&
                               isWithinSizeLimit(10); // 10MB for documents
      
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    // ==================== AUCTION IMAGES ====================
    // Auctions: /auctions/{auctionId}/{imageId}
    
    match /auctions/{auctionId}/{imageId} {
      allow read: if true; // Public auction images
      
      allow create, update: if isAdmin() ||
                               (isSeller() &&
                                isValidImage() &&
                                isWithinSizeLimit(10)); // 10MB limit
      
      allow delete: if isAdmin() || isSeller();
    }
    
    // ==================== ORDER DOCUMENTS ====================
    // Orders: /orders/{orderId}/{documentType}/{fileName}
    // Private - only order participants and admins
    
    match /orders/{orderId}/{documentType}/{fileName} {
      // Read access: Order owner, seller involved, or admin
      allow read: if isAuthenticated() && 
                     (isAdmin() || 
                      request.auth.token.email != null); // Authenticated users for their orders
      
      // Write access: Admins and authenticated users (for invoices, receipts)
      allow create, update: if isAuthenticated() &&
                               isValidDocument() &&
                               isWithinSizeLimit(5); // 5MB limit
      
      allow delete: if isAdmin();
    }
    
    // ==================== RETURN/REFUND DOCUMENTS ====================
    // Returns: /returns/{returnId}/{documentType}/{fileName}
    
    match /returns/{returnId}/{documentType}/{fileName} {
      allow read: if isAuthenticated() && 
                     (isAdmin() || 
                      request.auth.token.email != null);
      
      allow create, update: if isAuthenticated() &&
                               isValidDocument() &&
                               isWithinSizeLimit(10); // 10MB for return evidence
      
      allow delete: if isAdmin();
    }
    
    // ==================== REVIEW IMAGES ====================
    // Reviews: /reviews/{reviewId}/{imageId}
    
    match /reviews/{reviewId}/{imageId} {
      allow read: if true; // Public review images
      
      allow create, update: if isAdmin() ||
                               (isAuthenticated() &&
                                isValidImage() &&
                                isWithinSizeLimit(5)); // 5MB limit
      
      allow delete: if isAdmin() || isAuthenticated();
    }
    
    // ==================== CATEGORY IMAGES ====================
    // Categories: /categories/{categoryId}/{imageType}
    // Admin only
    
    match /categories/{categoryId}/{imageType} {
      allow read: if true; // Public category images
      
      allow create, update, delete: if isAdmin() &&
                                       isValidImage() &&
                                       isWithinSizeLimit(5); // 5MB limit
    }
    
    // ==================== BANNERS & PROMOTIONS ====================
    // Banners: /banners/{bannerId}
    // Admin only
    
    match /banners/{bannerId} {
      allow read: if true; // Public banners
      
      allow create, update, delete: if isAdmin() &&
                                       isValidImage() &&
                                       isWithinSizeLimit(10); // 10MB for high-quality banners
    }
    
    // ==================== BLOG/CMS ASSETS ====================
    // Blog: /blog/{postId}/{assetId}
    
    match /blog/{postId}/{assetId} {
      allow read: if true; // Public blog assets
      
      allow create, update, delete: if isAdmin() &&
                                       (isValidImage() || isValidDocument()) &&
                                       isWithinSizeLimit(10); // 10MB limit
    }
    
    // ==================== CHAT/MESSAGE ATTACHMENTS ====================
    // Messages: /messages/{conversationId}/{messageId}/{attachmentId}
    
    match /messages/{conversationId}/{messageId}/{attachmentId} {
      allow read: if isAuthenticated(); // Only authenticated users in conversation
      
      allow create: if isAuthenticated() &&
                       (isValidImage() || isValidDocument()) &&
                       isWithinSizeLimit(10); // 10MB limit
      
      allow delete: if isAuthenticated() || isAdmin();
    }
    
    // ==================== TEMPORARY UPLOADS ====================
    // Temp: /temp/{userId}/{fileName}
    // Used for image processing, cropping, etc.
    // Note: Implement Cloud Function to auto-delete files older than 24 hours
    
    match /temp/{userId}/{fileName} {
      allow read, create, update, delete: if isOwner(userId) &&
                                             isWithinSizeLimit(20); // 20MB temporary limit
    }
    
    // ==================== ADMIN ASSETS ====================
    // Admin: /admin/{assetType}/{fileName}
    // Admin-only assets
    
    match /admin/{assetType}/{fileName} {
      allow read: if isAdmin();
      
      allow create, update, delete: if isAdmin() &&
                                       isWithinSizeLimit(50); // 50MB for admin files
    }
    
    // ==================== PUBLIC ASSETS ====================
    // Public: /public/{assetType}/{fileName}
    // Publicly readable, admin writable
    
    match /public/{assetType}/{fileName} {
      allow read: if true;
      
      allow create, update, delete: if isAdmin();
    }
    
    // ==================== DEFAULT DENY ====================
    // Deny all other access by default
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
